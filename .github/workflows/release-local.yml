name: Release Local (No Developer ID)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "GitHub release tag (example: v1.2.3)"
        required: true
        type: string

concurrency:
  group: release-local-${{ github.workflow }}-${{ inputs.release_tag }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      release_tag: ${{ steps.validate.outputs.release_tag }}
    steps:
      - name: Validate input and required secret
        id: validate
        env:
          RELEASE_TAG: ${{ inputs.release_tag }}
          SPARKLE_PRIVATE_KEY_BASE64: ${{ secrets.SPARKLE_PRIVATE_KEY_BASE64 }}
        run: |
          set -euo pipefail

          if [[ -z "${RELEASE_TAG:-}" ]]; then
            echo "Missing required input: release_tag" >&2
            exit 1
          fi

          if [[ ! "$RELEASE_TAG" =~ ^v[0-9]+([.][0-9]+){0,2}$ ]]; then
            echo "Invalid release_tag format: $RELEASE_TAG (expected vX, vX.Y, or vX.Y.Z)" >&2
            exit 1
          fi

          if [[ -z "${SPARKLE_PRIVATE_KEY_BASE64:-}" ]]; then
            echo "Missing required secret: SPARKLE_PRIVATE_KEY_BASE64" >&2
            exit 1
          fi

          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"

  build_updates:
    needs: preflight
    runs-on: macos-15
    timeout-minutes: 60
    permissions:
      contents: read
    outputs:
      release_dmg_name: ${{ steps.metadata.outputs.release_dmg_name }}
      release_build_version: ${{ steps.metadata.outputs.release_build_version }}
      release_short_version: ${{ steps.metadata.outputs.release_short_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve package dependencies
        run: |
          /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild \
            -resolvePackageDependencies \
            -project PromptImprover.xcodeproj \
            -scheme PromptImprover

      - name: Locate Sparkle toolchain
        run: |
          set -euo pipefail
          sparkle_bin="$(find "$HOME/Library/Developer/Xcode/DerivedData" -type d -path '*/SourcePackages/artifacts/sparkle/Sparkle/bin' | head -n 1)"
          if [[ -z "$sparkle_bin" ]]; then
            echo "Could not locate Sparkle bin directory in DerivedData." >&2
            exit 1
          fi
          echo "SPARKLE_BIN=$sparkle_bin" >> "$GITHUB_ENV"

      - name: Install dmgbuild
        run: |
          python3 -m venv /tmp/dmgbuild-venv
          /tmp/dmgbuild-venv/bin/pip install --quiet dmgbuild
          echo "DMGBUILD_VENV=/tmp/dmgbuild-venv" >> "$GITHUB_ENV"

      - name: Build and generate updates (local mode, no publish)
        env:
          RELEASE_TAG: ${{ needs.preflight.outputs.release_tag }}
          SPARKLE_BIN: ${{ env.SPARKLE_BIN }}
          SPARKLE_PRIVATE_KEY_BASE64: ${{ secrets.SPARKLE_PRIVATE_KEY_BASE64 }}
          LOCAL_MACOSX_DEPLOYMENT_TARGET: "15.0"
          LOCAL_DISABLE_CODE_SIGNING: "1"
          LOCAL_ADHOC_SIGN_APP: "1"
          SKIP_PUBLISH: "1"
        run: |
          set -euo pipefail
          scripts/release/release-local.sh

      - name: Extract release metadata
        id: metadata
        run: |
          set -euo pipefail
          source scripts/release/.release-state.env

          : "${RELEASE_DMG_PATH:?missing RELEASE_DMG_PATH}"
          : "${RELEASE_BUILD_VERSION:?missing RELEASE_BUILD_VERSION}"
          : "${RELEASE_SHORT_VERSION:?missing RELEASE_SHORT_VERSION}"
          : "${RELEASE_TAG:?missing RELEASE_TAG}"

          test -f "$RELEASE_DMG_PATH"

          dmg_name="$(basename "$RELEASE_DMG_PATH")"
          echo "release_dmg_name=$dmg_name" >> "$GITHUB_OUTPUT"
          echo "release_build_version=$RELEASE_BUILD_VERSION" >> "$GITHUB_OUTPUT"
          echo "release_short_version=$RELEASE_SHORT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Upload updates artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-local-updates
          path: updates
          if-no-files-found: error

  publish:
    needs: [preflight, build_updates]
    runs-on: macos-15
    timeout-minutes: 30
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download updates artifact
        uses: actions/download-artifact@v4
        with:
          name: release-local-updates
          path: artifact-updates

      - name: Normalize downloaded updates
        id: normalize_updates
        env:
          RELEASE_DMG_NAME: ${{ needs.build_updates.outputs.release_dmg_name }}
        run: |
          set -euo pipefail

          preferred_appcast="$(find artifact-updates -type f -path '*/updates/stable/appcast.xml' | sort | head -n 1 || true)"
          if [[ -n "$preferred_appcast" ]]; then
            appcast_path="$preferred_appcast"
          else
            appcast_path="$(find artifact-updates -type f -name 'appcast.xml' | sort | head -n 1 || true)"
          fi

          if [[ -z "$appcast_path" ]]; then
            echo "Could not find appcast.xml in downloaded artifact." >&2
            find artifact-updates -maxdepth 5 -print || true
            exit 1
          fi

          source_dir="$(dirname "$appcast_path")"
          mkdir -p updates/stable
          rsync -a --delete "$source_dir/" updates/stable/

          if [[ ! -f "updates/stable/$RELEASE_DMG_NAME" ]]; then
            echo "Expected DMG not found after normalization: updates/stable/$RELEASE_DMG_NAME" >&2
            find updates/stable -maxdepth 5 -print || true
            exit 1
          fi

          echo "release_dmg_path=updates/stable/$RELEASE_DMG_NAME" >> "$GITHUB_OUTPUT"
          echo "release_appcast_path=updates/stable/appcast.xml" >> "$GITHUB_OUTPUT"

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Ensure release exists for tag
        env:
          RELEASE_TAG: ${{ needs.preflight.outputs.release_tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if gh release view "$RELEASE_TAG" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            echo "Release $RELEASE_TAG already exists."
          else
            gh release create "$RELEASE_TAG" \
              --repo "$GITHUB_REPOSITORY" \
              --target "$GITHUB_SHA" \
              --title "$RELEASE_TAG" \
              --notes "Automated non-notarized Sparkle release (no Developer ID)."
          fi

      - name: Publish release asset and feed
        env:
          RELEASE_TAG: ${{ needs.preflight.outputs.release_tag }}
          RELEASE_DMG_PATH: ${{ steps.normalize_updates.outputs.release_dmg_path }}
          RELEASE_APPCAST_PATH: ${{ steps.normalize_updates.outputs.release_appcast_path }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          scripts/release/40_publish_github.sh

      - name: Release summary
        env:
          RELEASE_TAG: ${{ needs.preflight.outputs.release_tag }}
          RELEASE_BUILD_VERSION: ${{ needs.build_updates.outputs.release_build_version }}
          RELEASE_SHORT_VERSION: ${{ needs.build_updates.outputs.release_short_version }}
          RELEASE_DMG_NAME: ${{ needs.build_updates.outputs.release_dmg_name }}
        run: |
          public_release_dmg_name="PromptImprover-${RELEASE_TAG}.dmg"
          {
            echo "## Release Local Summary"
            echo ""
            echo "- Tag: \\`$RELEASE_TAG\\`"
            echo "- Build version (CFBundleVersion): \\`$RELEASE_BUILD_VERSION\\`"
            echo "- Short version: \\`$RELEASE_SHORT_VERSION\\`"
            echo "- DMG public (GitHub Release): \\`$public_release_dmg_name\\`"
            echo "- DMG feed Sparkle (interno): \\`$RELEASE_DMG_NAME\\`"
            echo "- Release URL: https://github.com/${GITHUB_REPOSITORY}/releases/tag/$RELEASE_TAG"
            echo "- Appcast URL: https://jnjambrin0.github.io/PromptImprover/updates/stable/appcast.xml"
          } >> "$GITHUB_STEP_SUMMARY"
